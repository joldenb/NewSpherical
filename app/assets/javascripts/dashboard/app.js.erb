'use strict';

angular.module('sphericalApp', [
  'ngSanitize',
  'ngAnimate',
  'ui.router',
  'btford.markdown',
  'uuid4',
  'sphericalApp.filters',
  'sphericalApp.services',
  'sphericalApp.directives',
  'sphericalApp.controllers'
]).constant('SPHR_HST', "<%= ENV['FULLHOST'] %>")
.constant('WEBSOCKETS_URL', "<%= ENV['WEBSOCKETS_URL'] %>")
.config(['$sceDelegateProvider', 'SPHR_HST',function($sceDelegateProvider, SPHR_HST) {
    $sceDelegateProvider.resourceUrlWhitelist([
       "self",
       SPHR_HST + "**"]);
}])
.config(['$httpProvider', function ($httpProvider) {
  $httpProvider.interceptors.push('authInterceptor');
}])
.config(['$stateProvider', '$urlRouterProvider', 'SPHR_HST', function($stateProvider, $urlRouterProvider, SPHR_HST) {
  //$urlRouterProvider.otherwise("/");
  $stateProvider
    .state('sphere', {
        url: '/sphere',
        templateUrl: SPHR_HST + "dashboard/home",
        controller: 'MainCtrl'
    })
    .state('sphere.topic', {
        url: '/topic/:topic'
    })
    .state('sphere.topic.story', {
        url: '/story/:story'
    })
    .state('sphere.ctrlpanel', {
        url: '/ctrlpanel/:destination',
        views: {
          "ctrlpanel@sphere" : {
            templateUrl: function ($stateParams){
              return SPHR_HST + "tpls/" + $stateParams.destination + '.html';
            },
            controllerProvider: function($stateParams) {
                var controller_name = 'UserCtrl';
                switch($stateParams.destination) {
                    case 'forum':
                        controller_name = 'MainForumCtrl';
                        break;
                }
                return controller_name;
            }
          }
        }
    })
    .state('sphere.topic.ctrlpanel', {
        url: '/ctrlpanel/:destination',
        views: {
          "ctrlpanel@sphere" : {
            templateUrl: function ($stateParams){
              return SPHR_HST + "tpls/" + $stateParams.destination + '.html';
            },
            controllerProvider: function($stateParams) {
                var controller_name = 'UserCtrl';
                switch($stateParams.destination) {
                    case 'forum':
                        controller_name = 'MainForumCtrl';
                        break;
                }
                return controller_name;
            }
          }
        }
    })
    .state('sphere.topic.story.ctrlpanel', {
        url: '/ctrlpanel/:destination',
        views: {
          "ctrlpanel@sphere" : {
            templateUrl: function ($stateParams){
              return SPHR_HST + "tpls/" + $stateParams.destination + '.html';
            },
            controllerProvider: function($stateParams) {
                var controller_name = 'UserCtrl';
                switch($stateParams.destination) {
                    case 'forum':
                        controller_name = 'MainForumCtrl';
                        break;
                }
                return controller_name;
            }
          }
        }
    })
    .state('signin', {
        url: '/signin/:token',
        resolve: {
          sessionStore: function($window) {
              return $window.sessionStorage;
          },
          SigninVerify: 'SigninVerify'
        },
        controller: function($stateParams, $state, sessionStore, SigninVerify) {
            SigninVerify.get($stateParams.token)
            .then(function(signin_data) {
                if (signin_data) {
                  sessionStore.spheretoken = signin_data.jwt;
                  $state.go(signin_data.rtnstate.statename, signin_data.rtnstate.stateparams);
                } else {
                  delete sessionStore.spheretoken;
                  $state.go('sphere');
                }
            });
        }
    })

}])
.run(['$templateCache', 'SPHR_HST', function($templateCache, SPHR_HST) {
    $templateCache.put(SPHR_HST + "dashboard/sphere");
    $templateCache.put(SPHR_HST + "dashboard/topic_swiper");
    $templateCache.put(SPHR_HST + "tpls/profile_pic.html");
    $templateCache.put(SPHR_HST + "tpls/discussion_display.html");
    $templateCache.put(SPHR_HST + "tpls/discussion_edit.html");
}]);
